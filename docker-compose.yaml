version: "3.9"
services:
  nginx:
    image: "nginx:1.29-alpine"
    depends_on:
      - php
    volumes:
      - "./wordpress:/var/www/html"
      - type: bind
        source: ./nginx/nginx.conf
        target: /etc/nginx/nginx.conf
        read_only: true
        is_directory: false
        content: |
          worker_processes auto;

          events {
            worker_connections 1024;
          }

          http {
            include       mime.types;
            default_type  application/octet-stream;

            sendfile on;
            tcp_nopush on;
            tcp_nodelay on;
            keepalive_timeout 65;

            gzip on;
            gzip_comp_level 6;
            gzip_min_length 1024;
            gzip_types
              text/plain
              text/css
              application/javascript
              application/json
              image/svg+xml;

            fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;
            fastcgi_cache_key "$scheme$request_method$host$request_uri";

            include /etc/nginx/conf.d/*.conf;
          }
      - type: bind
        source: ./nginx/default.conf
        target: /etc/nginx/conf.d/default.conf
        read_only: true
        is_directory: false
        content: |
          server {
            listen 80;
            server_name _;
            root /var/www/html;

            index index.php;

            # Security headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "no-referrer-when-downgrade" always;

            set $skip_cache 0;

            if ($request_method = POST) {
              set $skip_cache 1;
            }

            if ($query_string != "") {
              set $skip_cache 1;
            }

            if ($request_uri ~* "/wp-admin/|/wp-login.php") {
              set $skip_cache 1;
            }

            location / {
              try_files $uri $uri/ /index.php?$args;
            }

            location ~ \.php$ {
              include fastcgi_params;
              fastcgi_pass php:9000;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

              fastcgi_cache WORDPRESS;
              fastcgi_cache_bypass $skip_cache;
              fastcgi_no_cache $skip_cache;
              fastcgi_cache_valid 200 60m;
              fastcgi_cache_valid 404 10m;
              add_header X-FastCGI-Cache $upstream_cache_status;
            }

            location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff2?|webp)$ {
              expires 1y;
              add_header Cache-Control "public, immutable";
              access_log off;
            }

            # Block access to sensitive files
            location ~ /\. {
              deny all;
            }
          }
      - "nginx_cache:/var/cache/nginx"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    healthcheck:
      test: ["CMD", "pgrep", "nginx"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
  php:
    image: "wordpress:php8.5-fpm-alpine"
    depends_on:
      - db
      - redis
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:?wordpress}
      WORDPRESS_DB_USER: ${SERVICE_USER_DB:?}
      WORDPRESS_DB_PASSWORD: ${SERVICE_PASSWORD_DB:?}
      WP_REDIS_HOST: redis
      WP_REDIS_PORT: 6379
      WP_REDIS_DATABASE: 0
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_REDIS_HOST', getenv('WP_REDIS_HOST') ?: 'redis');
        define('WP_REDIS_PORT', getenv('WP_REDIS_PORT') ?: 6379);
        define('WP_REDIS_DATABASE', getenv('WP_REDIS_DATABASE') ?: 0);
    volumes:
      - "./wordpress:/var/www/html"
      - type: bind
        source: ./php/php.ini
        target: /usr/local/etc/php/conf.d/zzz-custom.ini
        is_directory: false
        content: |
          memory_limit=256M
          max_execution_time=60
          upload_max_filesize=64M
          post_max_size=64M

          opcache.enable=1
          opcache.memory_consumption=256
          opcache.max_accelerated_files=100000
          opcache.validate_timestamps=0
          opcache.revalidate_freq=0
          opcache.jit=on
          opcache.jit_buffer_size=100M
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "1.0"
          memory: 512M
    healthcheck:
      test: ["CMD", "pgrep", "php-fpm"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
  db:
    image: "mariadb:12"
    environment:
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
      MYSQL_USER: ${SERVICE_USER_DB:?}
      MYSQL_PASSWORD: ${SERVICE_PASSWORD_DB:?}
      MYSQL_ROOT_PASSWORD: ${SERVICE_PASSWORD_ROOTDB:?}
    volumes:
      - "db_data:/var/lib/mysql"
    command:
      - "--innodb-buffer-pool-size=4G"
      - "--innodb-flush-log-at-trx-commit=2"
      - "--innodb-log-file-size=256M"
      - "--innodb-log-buffer-size=16M"
      - "--query-cache-size=64M"
      - "--query-cache-type=1"
      - "--max-connections=200"
      - "--innodb-thread-concurrency=16"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 2G
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 20s
      retries: 10
    restart: unless-stopped
  redis:
    image: "redis:8-alpine"
    volumes:
      - "redis_data:/data"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped
volumes:
  db_data: null
  nginx_cache: null
  redis_data: null
